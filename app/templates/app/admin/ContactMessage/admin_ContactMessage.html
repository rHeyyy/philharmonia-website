<!-- Search Section -->
<div id="search-section">
    <div id="header-section">

    </div>
    <input type="text" id="search-input" class="ContactMessage" placeholder="Search Messages...">
</div>

<div id="dashboard-container" class="container main main-content">
    <div id="users-section">
        {% if ContactMessages %}
        <!-- Mobile Cards View -->
        <div id="services-list" class="list-section mobile-cards">
            {% for message in ContactMessages %}
            <div class="instrument-card {% if not message.is_read %}unread-message{% endif %}">
                <div class="card-header">
                    <div class="instrument-title">
                        <h3>{{ message.subject }}</h3>
                        <p>
                            From: {{ message.name }}
                            {% if message.user %}
                            <span class="user-badge">(User: {{ message.user.username }})</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="instrument-detail">
                        <span class="detail-label">Email:</span>
                        <span class="detail-value">{{ message.email }}</span>
                    </div>
                    {% if message.user %}
                    <div class="instrument-detail">
                        <span class="detail-label">User ID:</span>
                        <span class="detail-value">#{{ message.user.id }}</span>
                    </div>
                    {% endif %}
                    <div class="instrument-detail">
                        <span class="detail-label">Message:</span>
                        <span class="detail-value">{{ message.message|truncatewords:12 }}</span>
                    </div>
                    <div class="instrument-detail">
                        <span class="detail-label">Received:</span>
                        <span class="detail-value">{{ message.submitted_at|date:"M d, Y" }}</span>
                    </div>
                    <div class="instrument-detail">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">
                            {% if message.is_read %}
                                <span class="status-read">Read</span>
                            {% else %}
                                <span class="status-unread">Unread</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="instrument-actions">
                        <a class="action-link View-ContactMessage" href="" data-ContactMessage-id="{{ message.pk }}">
                            <i class="fa-solid fa-eye" title="View Message"></i>
                        </a>
                        <a class="action-link delete-ContactMessage" href="" data-ContactMessage-id2="{{ message.pk }}">
                            <i class="fa-solid fa-trash" title="Delete Message"></i>
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Desktop Table View -->
        <div id="services-table" class="table-section">
            <table id="user-table" class="styled-table">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>From</th>
                        <th>User</th>
                        <th>Email</th>
                        <th>Message Preview</th>
                        <th>Received</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="user-tbody" class="ContactMessage1">
                    {% for message in ContactMessages %}
                    <tr>
                        <td>
                            <strong>{{ message.subject }}</strong>
                        </td>
                        <td>{{ message.name }}</td>
                        <td>
                            {% if message.user %}
                            <a>
                                {{ message.user.username }}
                            </a>
                            {% else %}
                            Guest
                            {% endif %}
                        </td>
                        <td>{{ message.email }}</td>
                        <td>{{ message.message|truncatewords:5 }}</td>
                        <td>{{ message.submitted_at|date:"M d, Y" }}</td>
                        <td>
                            {% if message.is_read %}
                                <span class="status-read">Read</span>
                            {% else %}
                                <span class="status-unread">Unread</span>
                            {% endif %}
                        </td>
                        <td>
                            <a class="action-link View-ContactMessage" href="" data-ContactMessage-id="{{ message.pk }}">
                                <i class="fa-solid fa-eye" title="View Message"></i>
                            </a>
                            |
                            <a class="action-link delete-ContactMessage" href="" data-ContactMessage-id2="{{ message.pk }}">
                                <i class="fa-solid fa-trash" title="Delete Message"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center">No messages found.</p>
        {% endif %}
    </div>
</div>


<div id="Delete-ContactMessage-Modal" class="Delete-ContactMessage-Modal">
    <div class="Delete-ContactMessage-modal-content">
        <div id="Delete-ContactMessage-modal-form-container">
            <!-- Dynamic form content will load here -->
        </div>
    </div>
</div>

<!--UPDATE ContactMessage-->
<div id="View-ContactMessage-Modal" class="View-ContactMessage-Modal">
    <div class="View-ContactMessage-modal-content">
        <span class="close-btn1">&times;</span>
        <div id="View-ContactMessage-modal-form-container">
            <!-- Dynamic form content will load here -->
        </div>
    </div>
</div>

<script>
    // Delete Instrument
document.addEventListener("DOMContentLoaded", () => {
    const delContactMessagemodal = document.getElementById("Delete-ContactMessage-Modal");
    const closeBtn = delContactMessagemodal.querySelector(".close-btn1");
    const delContactMessagemodalFormContainer = document.getElementById("Delete-ContactMessage-modal-form-container");
    const delContactMessageLinks = document.querySelectorAll(".delete-ContactMessage");

    // Handle clicking on the View link
    delContactMessageLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
            e.preventDefault();
            const ContactMessageId = link.getAttribute("data-ContactMessage-id2");

            // Load the form dynamically via fetch
            fetch(`/admin_ContactMessage/${ContactMessageId}/delete/`)
                .then((response) => response.text())
                .then((data) => {
                    delContactMessagemodalFormContainer.innerHTML = data;
                    delContactMessagemodal.classList.add("show"); // Show the modal
                })
                .catch((error) => {
                    delContactMessagemodalFormContainer.innerHTML = "<h2>Error loading form</h2>";
                    console.error("Error:", error);
                });
        });
    });

    // Close modal using the close button
    closeBtn.addEventListener("click", () => {
        delContactMessagemodal.classList.remove("show"); // Close the modal
    });
});


// Update ContactMessage
document.addEventListener("DOMContentLoaded", () => {
    const updateContactMessagemodal = document.getElementById("View-ContactMessage-Modal");
    const closeBtn = updateContactMessagemodal.querySelector(".close-btn1");
    const ContactMessagemodalFormContainer = document.getElementById("View-ContactMessage-modal-form-container");
    const ViewContactMessageLinks = document.querySelectorAll(".View-ContactMessage");

    // Handle clicking on the View link
    ViewContactMessageLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
            e.preventDefault();
            const ContactMessageId = link.getAttribute("data-ContactMessage-id");

            // Load the form dynamically via fetch
            fetch(`/admin_ContactMessage/${ContactMessageId}/edit/`)
                .then((response) => response.text())
                .then((data) => {
                    ContactMessagemodalFormContainer.innerHTML = data;
                    updateContactMessagemodal.classList.add("show"); // Show the modal
                })
                .catch((error) => {
                    ContactMessagemodalFormContainer.innerHTML = "<h2>Error loading form</h2>";
                    console.error("Error:", error);
                });
        });
    });

    // Close modal using the close button
    closeBtn.addEventListener("click", () => {
        updateContactMessagemodal.classList.remove("show"); // Close the modal
    });
});

document.addEventListener("DOMContentLoaded", () => {
    const searchInputContactMessage = document.querySelector(".ContactMessage"); // Input field
    const ContactMessageTableRows = document.querySelectorAll(".ContactMessage1 tr"); // Desktop table rows
    const ContactMessages = document.querySelectorAll(".instrument-card"); // Mobile cards

    searchInputContactMessage.addEventListener("input", () => {
        const query = searchInputContactMessage.value.toLowerCase().trim();

        // Search in desktop table
        ContactMessageTableRows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            const textContent = Array.from(cells)
                .map((cell) => cell.textContent.toLowerCase())
                .join(" ");

            row.style.display = textContent.includes(query) ? "" : "none";
        });

        // Search in mobile cards
        ContactMessages.forEach((card) => {
            const textContent = card.textContent.toLowerCase();
            card.style.display = textContent.includes(query) ? "" : "none";
        });
    });
});
</script>